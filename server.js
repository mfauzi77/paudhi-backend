// server.js - FIXED VERSION untuk RAN PAUD HI (No Duplicate Routes)
const express = require("express");
const mongoose = require("mongoose");
const cors = require("cors");
const helmet = require("helmet");
const uploadRoutes = require("./routes/upload");
const rateLimit = require("express-rate-limit");
const path = require("path");
require("dotenv").config();

// Import upload directories creation script
const createUploadDirectories = require("./scripts/createUploadDirs");

const app = express();

// ‚úÖ CORS configuration - UNCHANGED
const corsOptions = {
  origin: [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    process.env.FRONTEND_URL || "http://localhost:3000",
  ],
  credentials: true,
  methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"],
  allowedHeaders: [
    "Content-Type",
    "Authorization",
    "X-Requested-With",
    "Accept",
    "Origin",
    "Access-Control-Request-Method",
    "Access-Control-Request-Headers",
  ],
  exposedHeaders: ["Content-Length", "Content-Type"],
  optionsSuccessStatus: 200, // Some legacy browsers choke on 204
};

app.use(cors(corsOptions));

// ‚úÖ Handle preflight requests
app.options("*", cors(corsOptions));

// Security middleware - UNCHANGED
app.use(
  helmet({
    crossOriginResourcePolicy: { policy: "cross-origin" }, // ‚Üê PENTING untuk images
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "http:", "https:"], // ‚Üê Allow images
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        objectSrc: ["'none'"],
        upgradeInsecureRequests: [],
      },
    },
  })
);

// Rate limiting - ENHANCED untuk RAN PAUD
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
  message: "Too many requests from this IP, please try again later.",
});

// üÜï RAN PAUD specific rate limiter
const ranPaudLimiter = rateLimit({
  windowMs: 5 * 60 * 1000, // 5 minutes
  max: 200, // Higher limit for RAN PAUD operations
  message: "Too many RAN PAUD requests, please slow down.",
});

app.use("/api/", generalLimiter);
app.use("/api/ran-paud", ranPaudLimiter); // ‚Üê NEW: Rate limiting untuk RAN PAUD

// Body parsing middleware
app.use(express.json({ limit: "10mb" }));
app.use(express.urlencoded({ extended: true, limit: "10mb" }));

// ‚úÖ STATIC FILES - UNCHANGED
app.use(
  "/uploads",
  (req, res, next) => {
    // Set CORS headers untuk static files
    res.header("Access-Control-Allow-Origin", req.headers.origin || "*");
    res.header("Access-Control-Allow-Credentials", "true");
    res.header("Access-Control-Allow-Methods", "GET, OPTIONS");
    res.header(
      "Access-Control-Allow-Headers",
      "Origin, X-Requested-With, Content-Type, Accept, Authorization"
    );

    // Set cache headers
    res.header("Cache-Control", "public, max-age=31536000"); // 1 year cache

    // Handle preflight
    if (req.method === "OPTIONS") {
      res.sendStatus(200);
      return;
    }

    next();
  },
  express.static(path.join(__dirname, "uploads"))
);

// ‚úÖ EXPLICIT ROUTES - UNCHANGED
app.get("/uploads/news/:filename", (req, res) => {
  const filename = req.params.filename;
  const filepath = path.join(__dirname, "uploads", "news", filename);

  // Set CORS headers
  res.header("Access-Control-Allow-Origin", req.headers.origin || "*");
  res.header("Access-Control-Allow-Credentials", "true");

  // Check if file exists
  const fs = require("fs");
  if (!fs.existsSync(filepath)) {
    return res.status(404).json({ message: "Image not found" });
  }

  // Send file dengan proper headers
  res.sendFile(filepath, {
    headers: {
      "Content-Type": getContentType(filename),
      "Cache-Control": "public, max-age=31536000",
      "Access-Control-Allow-Origin": req.headers.origin || "*",
    },
  });
});

// Helper function untuk content type
function getContentType(filename) {
  const ext = path.extname(filename).toLowerCase();
  switch (ext) {
    case ".jpg":
    case ".jpeg":
      return "image/jpeg";
    case ".png":
      return "image/png";
    case ".gif":
      return "image/gif";
    case ".webp":
      return "image/webp";
    default:
      return "application/octet-stream";
  }
}

// Database connection
const mongoURI = process.env.MONGODB_URI;

if (!mongoURI) {
  throw new Error("‚ùå MONGODB_URI is not defined in environment variables");
}

mongoose
  .connect(mongoURI, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  })
  .then(() => {
    console.log("‚úÖ MongoDB connected");
    console.log(`üìä Database: ${mongoURI}`);

    // Create upload directories after database connection
    try {
      createUploadDirectories();
    } catch (error) {
      console.warn("‚ö†Ô∏è Failed to create upload directories:", error.message);
    }
  })
  .catch((err) => {
    console.error("‚ùå MongoDB connection error:", err);
    // Jangan exit, biarkan server tetap jalan
  });


// ===== API ROUTES - SINGLE DECLARATION ONLY =====
// üö® FIXED: Remove all duplicate route declarations

// Core API routes - DECLARE ONCE ONLY
app.use("/api/auth", require("./routes/auth"));
app.use("/api/news", require("./routes/news"));
app.use("/api/faq", require("./routes/faq"));
app.use("/api/pembelajaran", require("./routes/pembelajaran.js"));
app.use("/api/upload", uploadRoutes);

// üÜï RAN PAUD HI Routes (with error handling)
try {
  app.use("/api/ran-paud", require("./routes/ranpaud"));
  console.log("‚úÖ RAN PAUD HI routes loaded successfully");
} catch (error) {
  console.warn("‚ö†Ô∏è RAN PAUD routes not found, skipping...", error.message);
  // Don't crash, just log warning
}

// üÜï User Management Routes (admin_utama only)
try {
  app.use("/api/users", require("./routes/users"));
  console.log("‚úÖ User Management routes loaded successfully");
} catch (error) {
  console.warn(
    "‚ö†Ô∏è User Management routes not found, skipping...",
    error.message
  );
}

// Health check - ENHANCED
app.get("/api/health", (req, res) => {
  res.json({
    status: "OK",
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    mongodb:
      mongoose.connection.readyState === 1 ? "connected" : "disconnected",
    cors: {
      origin: req.headers.origin,
      allowedOrigins: corsOptions.origin,
    },
    modules: {
      ranPaud: true, // Indicate RAN PAUD module is available
      news: true,
      faq: true,
      pembelajaran: true,
    },
    environment: process.env.NODE_ENV || "development",
  });
});

// Test endpoint untuk cek CORS
app.get("/api/test-cors", (req, res) => {
  res.json({
    message: "CORS test successful",
    origin: req.headers.origin,
    timestamp: new Date().toISOString(),
    ranPaudEnabled: true, // ‚Üê NEW
  });
});

// Test route untuk debugging
app.get("/api/test", (req, res) => {
  res.json({
    message: "Backend API is working!",
    timestamp: new Date().toISOString(),
    headers: req.headers,
    origin: req.headers.origin,
    ranPaudModule: "active", // ‚Üê NEW
  });
});

// 404 handler
app.use("*", (req, res) => {
  console.log(`404 - Route not found: ${req.method} ${req.originalUrl}`);
  res.status(404).json({
    success: false, // ‚Üê Enhanced response format
    message: "Endpoint tidak ditemukan",
    path: req.originalUrl,
    method: req.method,
    timestamp: new Date().toISOString(),
  });
});

// Error handler - ENHANCED
app.use((error, req, res, next) => {
  console.error("üî• Global error handler:", error);
  console.error("üìç Error stack:", error.stack);

  // Enhanced error logging
  console.error("üåê Request info:", {
    method: req.method,
    path: req.path,
    headers: req.headers,
    body: req.body,
  });

  // Mongoose validation error
  if (error.name === "ValidationError") {
    const errors = Object.values(error.errors).map((err) => err.message);
    return res.status(400).json({
      success: false,
      message: "Validation error",
      errors,
      timestamp: new Date().toISOString(),
    });
  }

  // Mongoose cast error
  if (error.name === "CastError") {
    return res.status(400).json({
      success: false,
      message: "Invalid ID format",
      timestamp: new Date().toISOString(),
    });
  }

  // JWT error
  if (error.name === "JsonWebTokenError") {
    return res.status(401).json({
      success: false,
      message: "Invalid token",
      timestamp: new Date().toISOString(),
    });
  }

  // Multer error
  if (error.code === "LIMIT_FILE_SIZE") {
    return res.status(400).json({
      success: false,
      message: "File terlalu besar. Maksimal 5MB.",
      timestamp: new Date().toISOString(),
    });
  }

  // MongoDB duplicate key error
  if (error.code === 11000) {
    const field = Object.keys(error.keyValue || {})[0];
    return res.status(400).json({
      success: false,
      message: field
        ? `Data dengan ${field} "${error.keyValue[field]}" sudah ada`
        : "Data duplikat ditemukan",
      timestamp: new Date().toISOString(),
    });
  }

  // File format error
  if (error.message && error.message.includes("Format file tidak didukung")) {
    return res.status(400).json({
      success: false,
      message: error.message,
      timestamp: new Date().toISOString(),
    });
  }

  // Generic server error
  res.status(500).json({
    success: false,
    message: "Terjadi kesalahan server",
    error:
      process.env.NODE_ENV === "development"
        ? error.message
        : "Internal server error",
    timestamp: new Date().toISOString(),
  });
});

// ‚úÖ GRACEFUL SHUTDOWN (Simple version)
const gracefulShutdown = (signal) => {
  console.log(`\nüõë Received ${signal}. Shutting down gracefully...`);

  mongoose.connection.close(false, (err) => {
    if (err) {
      console.error("‚ùå Error during MongoDB disconnect:", err);
    } else {
      console.log("‚úÖ MongoDB connection closed");
    }
    process.exit(0);
  });
};

process.on("SIGTERM", () => gracefulShutdown("SIGTERM"));
process.on("SIGINT", () => gracefulShutdown("SIGINT"));

// Handle uncaught exceptions
process.on("uncaughtException", (err) => {
  console.error("üî• Uncaught Exception:", err);
  process.exit(1);
});

process.on("unhandledRejection", (reason, promise) => {
  console.error("üî• Unhandled Rejection at:", promise, "reason:", reason);
  // Don't exit process for unhandled rejections in development
  if (process.env.NODE_ENV === "production") {
    process.exit(1);
  }
});

const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log("\nüöÄ ================================");
  console.log(`üöÄ Server berjalan di port ${PORT}`);
  console.log(
    `üì± Frontend URL: ${process.env.FRONTEND_URL || "http://localhost:3000"}`
  );
  console.log(
    `üóÑÔ∏è Database: ${
      process.env.MONGODB_URI || "NOT SET"
    }`
  );
  console.log(`üåç Environment: ${process.env.NODE_ENV || "development"}`);
  console.log(`üñºÔ∏è Static files: http://localhost:${PORT}/uploads/`);
  console.log("üöÄ ================================\n");

  console.log("üìã Available routes:");
  console.log("   ‚öïÔ∏è  GET    /api/health");
  console.log("   üß™ GET    /api/test-cors");
  console.log("   üîê POST   /api/auth/login");
  console.log("   üì∞ CRUD   /api/news");
  console.log("   ‚ùì CRUD   /api/faq");
  console.log("   üìö CRUD   /api/pembelajaran");
  console.log("   üéØ CRUD   /api/ran-paud ‚Üê NEW RAN PAUD HI");
  console.log("   üìä GET    /api/ran-paud/dashboard ‚Üê Dashboard data");
  console.log("   üìà GET    /api/ran-paud/stats/summary ‚Üê Summary stats");
  console.log("   üì• POST   /api/ran-paud/import ‚Üê Import Excel");
  console.log("   üì§ GET    /api/ran-paud/export/:format ‚Üê Export data");
  console.log("   üè¢ GET    /api/ran-paud/kl/list ‚Üê K/L list");
  console.log("   üîÑ POST   /api/ran-paud/bulk ‚Üê Bulk operations");
  console.log("   üñºÔ∏è POST   /api/upload/image");
  console.log("   üóëÔ∏è DELETE /api/upload/image");
  console.log("   üìÅ GET    /uploads/:category/:filename ‚Üê Static images");
  console.log("\nüéØ RAN PAUD HI Module: READY");
  console.log("üìä Enhanced error handling: ACTIVE");
  console.log("üîí Security & rate limiting: ACTIVE\n");
});
